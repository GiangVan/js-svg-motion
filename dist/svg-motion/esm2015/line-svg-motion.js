export class LineSvgMotion {
    constructor() {
        this.lineAnimations = [];
    }
    getLineAnimations() {
        return this.lineAnimations;
    }
    static drawLineGroupToVolume(dAttribute, element, volume, reverse = false) {
        const pointGroups = this.generatePointGroups(dAttribute);
        for (let i = 0; i < pointGroups.length; i++) {
            if (reverse) {
                pointGroups[i] = pointGroups[i].reverse();
            }
            dAttribute = this.drawLineToVolume(pointGroups[i], i + 1, dAttribute, element, volume);
        }
        return dAttribute;
    }
    animateLineGroup(dAttribute, element, { time: time = 1000, step: step = 100, isReversed: isReversed = false, mode: mode = 'EXPAND' }, finishCallback = null) {
        mode = mode.toUpperCase();
        const lineAnimationId = this.pushNewLineAnimation();
        switch (mode) {
            case 'COLLAPSE':
                this.handleAnimationCollapseMode(lineAnimationId, dAttribute, element, step, time, isReversed, finishCallback);
                break;
            case 'LOADING':
                this.handleAnimationLoadingMode(lineAnimationId, dAttribute, element, step, time, isReversed);
                break;
            case 'LOADING2':
                this.handleAnimationLoading2Mode(lineAnimationId, dAttribute, element, step, time, isReversed);
                break;
            case 'LOADING3':
                this.handleAnimationLoading3Mode(lineAnimationId, dAttribute, element, step, time, isReversed);
                break;
            case 'LOADING4':
                this.handleAnimationLoading4Mode(lineAnimationId, dAttribute, element, step, time, isReversed);
                break;
            default:
                this.handleAnimationNormalMode(lineAnimationId, dAttribute, element, step, time, isReversed, finishCallback);
                break;
        }
        return lineAnimationId;
    }
    calcMotionTrigonometricEquations(x) {
        return Math.sin((Math.PI / 2) * Math.pow(x, 6));
    }
    generateLineAnimationId() {
        return Symbol();
    }
    removeLineAnimation(id) {
        const index = this.lineAnimations.indexOf(id);
        if (index !== -1) {
            this.lineAnimations.splice(index, 1);
        }
    }
    existLineAnimation(id) {
        return this.lineAnimations.indexOf(id) !== -1;
    }
    pushNewLineAnimation() {
        const key = this.generateLineAnimationId();
        this.lineAnimations.push(key);
        return key;
    }
    handleAnimationLoadingMode(animationId, dAttribute, element, step, time, isReversed) {
        const speed = time / step;
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 0, true, isReversed, () => {
            this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 100, false, !isReversed, () => {
                this.handleAnimationLoadingMode(animationId, dAttribute, element, step, time, isReversed);
            });
        });
    }
    handleAnimationLoading2Mode(animationId, dAttribute, element, step, time, isReversed) {
        const speed = time / step;
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 0, true, isReversed, () => {
            this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 100, false, isReversed, () => {
                this.handleAnimationLoading2Mode(animationId, dAttribute, element, step, time, isReversed);
            });
        });
    }
    handleAnimationLoading3Mode(animationId, dAttribute, element, step, time, isReversed) {
        const speed = time / step;
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 100, false, !isReversed, () => {
            this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 0, true, isReversed, () => {
                this.handleAnimationLoading3Mode(animationId, dAttribute, element, step, time, isReversed);
            });
        });
    }
    handleAnimationLoading4Mode(animationId, dAttribute, element, step, time, isReversed) {
        const speed = time / step;
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 100, false, isReversed, () => {
            this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, 0, true, !isReversed, () => {
                this.handleAnimationLoading4Mode(animationId, dAttribute, element, step, time, isReversed);
            });
        });
    }
    handleAnimationCollapseMode(animationId, dAttribute, element, step, time, isReversed, finishCallback) {
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, (time / step), 100, false, isReversed, finishCallback);
    }
    handleAnimationNormalMode(animationId, dAttribute, element, step, time, isReversed, finishCallback) {
        this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, (time / step), 0, true, isReversed, finishCallback);
    }
    recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, currentStep, isExpand, isReversed, finishCallback) {
        if (this.existLineAnimation(animationId)) {
            LineSvgMotion.drawLineGroupToVolume(dAttribute, element, 100 * this.calcMotionTrigonometricEquations(currentStep / step), isReversed);
            if ((isExpand && currentStep === step) ||
                (!isExpand && currentStep === 0)) {
                if (finishCallback != null) {
                    finishCallback();
                }
            }
            else {
                if (isExpand) {
                    currentStep++;
                }
                else {
                    currentStep--;
                }
                setTimeout(() => (this.recursiveAnimationLineGroup(animationId, dAttribute, element, step, speed, currentStep, isExpand, isReversed, finishCallback)), speed);
            }
        }
    }
    static generatePointGroups(dAttribute) {
        const pointGroupStrings = dAttribute.split("M");
        const pointGroups = [];
        if (pointGroupStrings[0] === "") {
            for (let i = 1; i < pointGroupStrings.length; i++) {
                const pointStrings = pointGroupStrings[i].split("L");
                for (let j = 0; j < pointStrings.length; j++) {
                    const point = [
                        parseFloat(pointStrings[j].split(",")[0]),
                        parseFloat(pointStrings[j].split(",")[1]),
                    ];
                    if (pointGroups[i - 1] === undefined) {
                        pointGroups[i - 1] = [];
                    }
                    pointGroups[i - 1][pointGroups[i - 1].length] = point;
                }
            }
        }
        else {
            alert("not found M");
        }
        return pointGroups.length > 0 ? pointGroups : null;
    }
    static countOccurrences(text, search) {
        return text.split(search).length - 1;
    }
    static getRangeOf(text, search, no) {
        if (this.countOccurrences(text, search) >= no) {
            let startIndex = 0;
            let endIndex = 0;
            let n = 0;
            while (n < no) {
                startIndex = text.indexOf(search, startIndex) + search.length;
                n++;
            }
            endIndex = (text.indexOf(search, startIndex) === -1) ? text.length : text.indexOf(search, startIndex);
            return [
                startIndex,
                endIndex
            ];
        }
        else {
            return null;
        }
    }
    static getPointsDistance(point1, point2) {
        return Math.sqrt(Math.pow(point2[0] - point1[0], 2) + Math.pow(point2[1] - point1[1], 2));
    }
    static getLineLength(pointGroup) {
        let length = 0.0;
        for (let i = 1; i < pointGroup.length; i++) {
            length += this.getPointsDistance(pointGroup[i - 1], pointGroup[i]);
        }
        return length;
    }
    static roundPoint(point) {
        point[0] = Math.round((point[0] + Number.EPSILON) * 1000) / 1000;
        point[1] = Math.round((point[1] + Number.EPSILON) * 1000) / 1000;
        return point;
    }
    static changePointGroupAtLength(pointGroup, length) {
        let currentLength = 0;
        const newPointGroup = [pointGroup[0]];
        for (let i = 1; i < pointGroup.length; i++) {
            const currentLineLength = this.getPointsDistance(pointGroup[i - 1], pointGroup[i]);
            currentLength += currentLineLength;
            newPointGroup.push(pointGroup[i]);
            if (currentLength >= length) {
                const newLineLength = length + currentLineLength - currentLength;
                const betweenLengthRatio = newLineLength / currentLineLength;
                newPointGroup[i] = this.roundPoint([
                    pointGroup[i - 1][0] + ((pointGroup[i][0] - pointGroup[i - 1][0]) * betweenLengthRatio),
                    pointGroup[i - 1][1] + ((pointGroup[i][1] - pointGroup[i - 1][1]) * betweenLengthRatio)
                ]);
                break;
            }
        }
        return newPointGroup;
    }
    static getPointGroupStringMissing(pointGroupString, pointGroupNo) {
        const pointGroupNum = this.countOccurrences(pointGroupString, 'M');
        let pointGroupMissingNum = 0;
        let pointGroupMissingString = '';
        if (pointGroupNo - pointGroupNum > 1) {
            pointGroupMissingNum = pointGroupNo - pointGroupNum - 1;
        }
        for (let i = 0; i < pointGroupMissingNum; i++) {
            pointGroupMissingString += 'M0,0';
        }
        return pointGroupMissingString;
    }
    static drawLineToVolume(pointGroup, pointGroupNo, dAttribute, element, volume) {
        if (volume >= 0 && volume <= 100) {
            const length = this.getLineLength(pointGroup) / 100 * volume;
            const newPointGroup = this.changePointGroupAtLength(pointGroup, length);
            let workRange = this.getRangeOf(dAttribute, 'M', pointGroupNo);
            let lineString = '';
            for (let i = 0; i < newPointGroup.length; i++) {
                lineString += lineString == '' ? '' : 'L';
                lineString += `${newPointGroup[i][0]},${newPointGroup[i][1]}`;
            }
            if (workRange === null) {
                dAttribute = `${dAttribute}${this.getPointGroupStringMissing(dAttribute, pointGroupNo)}M${lineString}`;
            }
            else {
                dAttribute = dAttribute.substring(0, workRange[0]) + lineString + dAttribute.substring(workRange[1], dAttribute.length);
            }
            element.setAttribute('d', dAttribute);
            return dAttribute;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS1zdmctbW90aW9uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vc3ZnLW1vdGlvbi8iLCJzb3VyY2VzIjpbImxpbmUtc3ZnLW1vdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxNQUFNLE9BQU8sYUFBYTtJQUd6QjtRQUZVLG1CQUFjLEdBQWEsRUFBRSxDQUFDO0lBRXhCLENBQUM7SUFFVixpQkFBaUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0lBQzVCLENBQUM7SUFFTSxNQUFNLENBQUMscUJBQXFCLENBQUMsVUFBa0IsRUFBRSxPQUFvQixFQUFFLE1BQWMsRUFBRSxVQUFtQixLQUFLO1FBQ3JILE1BQU0sV0FBVyxHQUFpQixJQUFJLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFdkUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDNUMsSUFBSSxPQUFPLEVBQUU7Z0JBQ1osV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUMxQztZQUVELFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztTQUN2RjtRQUVELE9BQU8sVUFBVSxDQUFDO0lBQ25CLENBQUM7SUFFTSxnQkFBZ0IsQ0FDdEIsVUFBa0IsRUFDbEIsT0FBb0IsRUFDcEIsRUFDQyxJQUFJLEVBQUUsSUFBSSxHQUFHLElBQUksRUFDakIsSUFBSSxFQUFFLElBQUksR0FBRyxHQUFHLEVBQ2hCLFVBQVUsRUFBRSxVQUFVLEdBQUcsS0FBSyxFQUM5QixJQUFJLEVBQUUsSUFBSSxHQUFHLFFBQVEsRUFDckIsRUFDRCxpQkFBNkIsSUFBSTtRQUdq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QUFTLEdBQWEsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ3pFLElBQUksVUFBVSxHQUFXLEVBQUUsQ0FBQztZQUU1QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDOUMsVUFBVSxJQUFJLFVBQVUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO2dCQUMxQyxVQUFVLElBQUksR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7YUFDOUQ7WUFFRCxJQUFJLFNBQVMsS0FBSyxJQUFJLEVBQUU7Z0JBQ3ZCLFVBQVUsR0FBRyxHQUFHLFVBQVUsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxJQUFJLFVBQVUsRUFBRSxDQUFDO2FBQ3ZHO2lCQUFNO2dCQUNOLFVBQVUsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3hIO1lBRUQsT0FBTyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDdEMsT0FBTyxVQUFVLENBQUM7U0FDbEI7SUFDRixDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcbmV4cG9ydCBjbGFzcyBMaW5lU3ZnTW90aW9uIHtcblx0cHJvdGVjdGVkIGxpbmVBbmltYXRpb25zOiBzeW1ib2xbXSA9IFtdO1xuXG5cdGNvbnN0cnVjdG9yKCkgeyB9XG5cblx0cHVibGljIGdldExpbmVBbmltYXRpb25zKCk6IHN5bWJvbFtdIHtcblx0XHRyZXR1cm4gdGhpcy5saW5lQW5pbWF0aW9ucztcblx0fVxuXG5cdHB1YmxpYyBzdGF0aWMgZHJhd0xpbmVHcm91cFRvVm9sdW1lKGRBdHRyaWJ1dGU6IHN0cmluZywgZWxlbWVudDogSFRNTEVsZW1lbnQsIHZvbHVtZTogbnVtYmVyLCByZXZlcnNlOiBib29sZWFuID0gZmFsc2UpOiBzdHJpbmcge1xuXHRcdGNvbnN0IHBvaW50R3JvdXBzOiBudW1iZXJbXVtdW10gPSB0aGlzLmdlbmVyYXRlUG9pbnRHcm91cHMoZEF0dHJpYnV0ZSk7XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHBvaW50R3JvdXBzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRpZiAocmV2ZXJzZSkge1xuXHRcdFx0XHRwb2ludEdyb3Vwc1tpXSA9IHBvaW50R3JvdXBzW2ldLnJldmVyc2UoKTtcblx0XHRcdH1cblxuXHRcdFx0ZEF0dHJpYnV0ZSA9IHRoaXMuZHJhd0xpbmVUb1ZvbHVtZShwb2ludEdyb3Vwc1tpXSwgaSArIDEsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHZvbHVtZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGRBdHRyaWJ1dGU7XG5cdH1cblxuXHRwdWJsaWMgYW5pbWF0ZUxpbmVHcm91cChcblx0XHRkQXR0cmlidXRlOiBzdHJpbmcsXG5cdFx0ZWxlbWVudDogSFRNTEVsZW1lbnQsXG5cdFx0e1xuXHRcdFx0dGltZTogdGltZSA9IDEwMDAsXG5cdFx0XHRzdGVwOiBzdGVwID0gMTAwLFxuXHRcdFx0aXNSZXZlcnNlZDogaXNSZXZlcnNlZCA9IGZhbHNlLFxuXHRcdFx0bW9kZTogbW9kZSA9ICdFWFBBTkQnXG5cdFx0fSxcblx0XHRmaW5pc2hDYWxsYmFjazogKCkgPT4gdm9pZCA9IG51bGxcblx0KTogc3ltYm9sIHtcblx0XHRcblx0XHRtb2RlID0gbW9kZS50b1VwcGVyQ2FzZSgpO1xuXHRcdGNvbnN0IGxpbmVBbmltYXRpb25JZDogc3ltYm9sID0gdGhpcy5wdXNoTmV3TGluZUFuaW1hdGlvbigpO1xuXG5cdFx0c3dpdGNoIChtb2RlKSB7XG5cdFx0XHRjYXNlICdDT0xMQVBTRSc6XG5cdFx0XHRcdHRoaXMuaGFuZGxlQW5pbWF0aW9uQ29sbGFwc2VNb2RlKGxpbmVBbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgdGltZSwgaXNSZXZlcnNlZCwgZmluaXNoQ2FsbGJhY2spO1xuXHRcdFx0XHRicmVhaztcblxuXHRcdFx0Y2FzZSAnTE9BRElORyc6XG5cdFx0XHRcdHRoaXMuaGFuZGxlQW5pbWF0aW9uTG9hZGluZ01vZGUobGluZUFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCB0aW1lLCBpc1JldmVyc2VkKTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgJ0xPQURJTkcyJzpcblx0XHRcdFx0dGhpcy5oYW5kbGVBbmltYXRpb25Mb2FkaW5nMk1vZGUobGluZUFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCB0aW1lLCBpc1JldmVyc2VkKTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgJ0xPQURJTkczJzpcblx0XHRcdFx0dGhpcy5oYW5kbGVBbmltYXRpb25Mb2FkaW5nM01vZGUobGluZUFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCB0aW1lLCBpc1JldmVyc2VkKTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGNhc2UgJ0xPQURJTkc0Jzpcblx0XHRcdFx0dGhpcy5oYW5kbGVBbmltYXRpb25Mb2FkaW5nNE1vZGUobGluZUFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCB0aW1lLCBpc1JldmVyc2VkKTtcblx0XHRcdFx0YnJlYWs7XG5cblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdHRoaXMuaGFuZGxlQW5pbWF0aW9uTm9ybWFsTW9kZShsaW5lQW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHRpbWUsIGlzUmV2ZXJzZWQsIGZpbmlzaENhbGxiYWNrKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGxpbmVBbmltYXRpb25JZDtcblx0fVxuXG5cblx0cHJvdGVjdGVkIGNhbGNNb3Rpb25Ucmlnb25vbWV0cmljRXF1YXRpb25zKHg6IG51bWJlcik6IG51bWJlciB7XG5cdFx0cmV0dXJuIE1hdGguc2luKChNYXRoLlBJIC8gMikgKiBNYXRoLnBvdyh4LCA2KSk7XG5cdH1cblxuXG5cdHByb3RlY3RlZCBnZW5lcmF0ZUxpbmVBbmltYXRpb25JZCgpOiBzeW1ib2wge1xuXHRcdHJldHVybiBTeW1ib2woKTtcblx0fVxuXG5cdHByb3RlY3RlZCByZW1vdmVMaW5lQW5pbWF0aW9uKGlkOiBzeW1ib2wpIHtcblx0XHRjb25zdCBpbmRleDogbnVtYmVyID0gdGhpcy5saW5lQW5pbWF0aW9ucy5pbmRleE9mKGlkKTtcblx0XHRpZiAoaW5kZXggIT09IC0xKSB7XG5cdFx0XHR0aGlzLmxpbmVBbmltYXRpb25zLnNwbGljZShpbmRleCwgMSk7XG5cdFx0fVxuXHR9XG5cblx0cHJvdGVjdGVkIGV4aXN0TGluZUFuaW1hdGlvbihpZDogc3ltYm9sKSB7XG5cdFx0cmV0dXJuIHRoaXMubGluZUFuaW1hdGlvbnMuaW5kZXhPZihpZCkgIT09IC0xO1xuXHR9XG5cblx0cHJvdGVjdGVkIHB1c2hOZXdMaW5lQW5pbWF0aW9uKCk6IHN5bWJvbCB7XG5cdFx0Y29uc3Qga2V5OiBzeW1ib2wgPSB0aGlzLmdlbmVyYXRlTGluZUFuaW1hdGlvbklkKCk7XG5cblx0XHR0aGlzLmxpbmVBbmltYXRpb25zLnB1c2goa2V5KTtcblxuXHRcdHJldHVybiBrZXk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaGFuZGxlQW5pbWF0aW9uTG9hZGluZ01vZGUoYW5pbWF0aW9uSWQ6IHN5bWJvbCwgZEF0dHJpYnV0ZTogc3RyaW5nLCBlbGVtZW50OiBIVE1MRWxlbWVudCwgc3RlcDogbnVtYmVyLCB0aW1lOiBudW1iZXIsIGlzUmV2ZXJzZWQ6IGJvb2xlYW4pIHtcblx0XHRjb25zdCBzcGVlZDogbnVtYmVyID0gdGltZSAvIHN0ZXA7XG5cdFx0dGhpcy5yZWN1cnNpdmVBbmltYXRpb25MaW5lR3JvdXAoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHNwZWVkLCAwLCB0cnVlLCBpc1JldmVyc2VkLCAoKSA9PiB7XG5cdFx0XHR0aGlzLnJlY3Vyc2l2ZUFuaW1hdGlvbkxpbmVHcm91cChhbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgc3BlZWQsIDEwMCwgZmFsc2UsICFpc1JldmVyc2VkLCAoKSA9PiB7XG5cdFx0XHRcdHRoaXMuaGFuZGxlQW5pbWF0aW9uTG9hZGluZ01vZGUoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHRpbWUsIGlzUmV2ZXJzZWQpO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaGFuZGxlQW5pbWF0aW9uTG9hZGluZzJNb2RlKGFuaW1hdGlvbklkOiBzeW1ib2wsIGRBdHRyaWJ1dGU6IHN0cmluZywgZWxlbWVudDogSFRNTEVsZW1lbnQsIHN0ZXA6IG51bWJlciwgdGltZTogbnVtYmVyLCBpc1JldmVyc2VkOiBib29sZWFuKSB7XG5cdFx0Y29uc3Qgc3BlZWQ6IG51bWJlciA9IHRpbWUgLyBzdGVwO1xuXHRcdHRoaXMucmVjdXJzaXZlQW5pbWF0aW9uTGluZUdyb3VwKGFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCBzcGVlZCwgMCwgdHJ1ZSwgaXNSZXZlcnNlZCwgKCkgPT4ge1xuXHRcdFx0dGhpcy5yZWN1cnNpdmVBbmltYXRpb25MaW5lR3JvdXAoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHNwZWVkLCAxMDAsIGZhbHNlLCBpc1JldmVyc2VkLCAoKSA9PiB7XG5cdFx0XHRcdHRoaXMuaGFuZGxlQW5pbWF0aW9uTG9hZGluZzJNb2RlKGFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCB0aW1lLCBpc1JldmVyc2VkKTtcblx0XHRcdH0pO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJvdGVjdGVkIGhhbmRsZUFuaW1hdGlvbkxvYWRpbmczTW9kZShhbmltYXRpb25JZDogc3ltYm9sLCBkQXR0cmlidXRlOiBzdHJpbmcsIGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzdGVwOiBudW1iZXIsIHRpbWU6IG51bWJlciwgaXNSZXZlcnNlZDogYm9vbGVhbikge1xuXHRcdGNvbnN0IHNwZWVkOiBudW1iZXIgPSB0aW1lIC8gc3RlcDtcblx0XHR0aGlzLnJlY3Vyc2l2ZUFuaW1hdGlvbkxpbmVHcm91cChhbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgc3BlZWQsIDEwMCwgZmFsc2UsICFpc1JldmVyc2VkLCAoKSA9PiB7XG5cdFx0XHR0aGlzLnJlY3Vyc2l2ZUFuaW1hdGlvbkxpbmVHcm91cChhbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgc3BlZWQsIDAsIHRydWUsIGlzUmV2ZXJzZWQsICgpID0+IHtcblx0XHRcdFx0dGhpcy5oYW5kbGVBbmltYXRpb25Mb2FkaW5nM01vZGUoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHRpbWUsIGlzUmV2ZXJzZWQpO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaGFuZGxlQW5pbWF0aW9uTG9hZGluZzRNb2RlKGFuaW1hdGlvbklkOiBzeW1ib2wsIGRBdHRyaWJ1dGU6IHN0cmluZywgZWxlbWVudDogSFRNTEVsZW1lbnQsIHN0ZXA6IG51bWJlciwgdGltZTogbnVtYmVyLCBpc1JldmVyc2VkOiBib29sZWFuKSB7XG5cdFx0Y29uc3Qgc3BlZWQ6IG51bWJlciA9IHRpbWUgLyBzdGVwO1xuXHRcdHRoaXMucmVjdXJzaXZlQW5pbWF0aW9uTGluZUdyb3VwKGFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCBzcGVlZCwgMTAwLCBmYWxzZSwgaXNSZXZlcnNlZCwgKCkgPT4ge1xuXHRcdFx0dGhpcy5yZWN1cnNpdmVBbmltYXRpb25MaW5lR3JvdXAoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsIHNwZWVkLCAwLCB0cnVlLCAhaXNSZXZlcnNlZCwgKCkgPT4ge1xuXHRcdFx0XHR0aGlzLmhhbmRsZUFuaW1hdGlvbkxvYWRpbmc0TW9kZShhbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgdGltZSwgaXNSZXZlcnNlZCk7XG5cdFx0XHR9KTtcblx0XHR9KTtcblx0fVxuXG5cdHByb3RlY3RlZCBoYW5kbGVBbmltYXRpb25Db2xsYXBzZU1vZGUoYW5pbWF0aW9uSWQ6IHN5bWJvbCwgZEF0dHJpYnV0ZTogc3RyaW5nLCBlbGVtZW50OiBIVE1MRWxlbWVudCwgc3RlcDogbnVtYmVyLCB0aW1lOiBudW1iZXIsIGlzUmV2ZXJzZWQ6IGJvb2xlYW4sIGZpbmlzaENhbGxiYWNrPzogKCkgPT4gdm9pZCkge1xuXHRcdHRoaXMucmVjdXJzaXZlQW5pbWF0aW9uTGluZUdyb3VwKGFuaW1hdGlvbklkLCBkQXR0cmlidXRlLCBlbGVtZW50LCBzdGVwLCAodGltZSAvIHN0ZXApLCAxMDAsIGZhbHNlLCBpc1JldmVyc2VkLCBmaW5pc2hDYWxsYmFjayk7XG5cdH1cblxuXHRwcm90ZWN0ZWQgaGFuZGxlQW5pbWF0aW9uTm9ybWFsTW9kZShhbmltYXRpb25JZDogc3ltYm9sLCBkQXR0cmlidXRlOiBzdHJpbmcsIGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzdGVwOiBudW1iZXIsIHRpbWU6IG51bWJlciwgaXNSZXZlcnNlZDogYm9vbGVhbiwgZmluaXNoQ2FsbGJhY2s/OiAoKSA9PiB2b2lkKSB7XG5cdFx0dGhpcy5yZWN1cnNpdmVBbmltYXRpb25MaW5lR3JvdXAoYW5pbWF0aW9uSWQsIGRBdHRyaWJ1dGUsIGVsZW1lbnQsIHN0ZXAsICh0aW1lIC8gc3RlcCksIDAsIHRydWUsIGlzUmV2ZXJzZWQsIGZpbmlzaENhbGxiYWNrKTtcblx0fVxuXG5cdHByb3RlY3RlZCByZWN1cnNpdmVBbmltYXRpb25MaW5lR3JvdXAoYW5pbWF0aW9uSWQ6IHN5bWJvbCwgZEF0dHJpYnV0ZTogc3RyaW5nLCBlbGVtZW50OiBIVE1MRWxlbWVudCwgc3RlcDogbnVtYmVyLCBzcGVlZDogbnVtYmVyLCBjdXJyZW50U3RlcDogbnVtYmVyLCBpc0V4cGFuZCwgaXNSZXZlcnNlZDogYm9vbGVhbiwgZmluaXNoQ2FsbGJhY2s/OiAoKSA9PiB2b2lkKSB7XG5cdFx0aWYgKHRoaXMuZXhpc3RMaW5lQW5pbWF0aW9uKGFuaW1hdGlvbklkKSkge1xuXHRcdFx0TGluZVN2Z01vdGlvbi5kcmF3TGluZUdyb3VwVG9Wb2x1bWUoZEF0dHJpYnV0ZSwgZWxlbWVudCwgMTAwICogdGhpcy5jYWxjTW90aW9uVHJpZ29ub21ldHJpY0VxdWF0aW9ucyhjdXJyZW50U3RlcCAvIHN0ZXApLCBpc1JldmVyc2VkKTtcblxuXHRcdFx0aWYgKFxuXHRcdFx0XHQoaXNFeHBhbmQgJiYgY3VycmVudFN0ZXAgPT09IHN0ZXApIHx8XG5cdFx0XHRcdCghaXNFeHBhbmQgJiYgY3VycmVudFN0ZXAgPT09IDApXG5cdFx0XHQpIHtcblx0XHRcdFx0aWYgKGZpbmlzaENhbGxiYWNrICE9IG51bGwpIHtcblx0XHRcdFx0XHRmaW5pc2hDYWxsYmFjaygpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpZiAoaXNFeHBhbmQpIHtcblx0XHRcdFx0XHRjdXJyZW50U3RlcCsrO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGN1cnJlbnRTdGVwLS07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRzZXRUaW1lb3V0KFxuXHRcdFx0XHRcdCgpID0+ICh0aGlzLnJlY3Vyc2l2ZUFuaW1hdGlvbkxpbmVHcm91cChhbmltYXRpb25JZCwgZEF0dHJpYnV0ZSwgZWxlbWVudCwgc3RlcCwgc3BlZWQsIGN1cnJlbnRTdGVwLCBpc0V4cGFuZCwgaXNSZXZlcnNlZCwgZmluaXNoQ2FsbGJhY2spKVxuXHRcdFx0XHRcdCwgc3BlZWRcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcm90ZWN0ZWQgc3RhdGljIGdlbmVyYXRlUG9pbnRHcm91cHMoZEF0dHJpYnV0ZTogc3RyaW5nKTogbnVsbCB8IG51bWJlcltdW11bXSB7XG5cdFx0Y29uc3QgcG9pbnRHcm91cFN0cmluZ3M6IHN0cmluZ1tdID0gZEF0dHJpYnV0ZS5zcGxpdChcIk1cIik7XG5cdFx0Y29uc3QgcG9pbnRHcm91cHM6IG51bWJlcltdW11bXSA9IFtdO1xuXG5cdFx0aWYgKHBvaW50R3JvdXBTdHJpbmdzWzBdID09PSBcIlwiKSB7XG5cdFx0XHRmb3IgKGxldCBpID0gMTsgaSA8IHBvaW50R3JvdXBTdHJpbmdzLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdGNvbnN0IHBvaW50U3RyaW5ncyA9IHBvaW50R3JvdXBTdHJpbmdzW2ldLnNwbGl0KFwiTFwiKTtcblxuXHRcdFx0XHRmb3IgKGxldCBqID0gMDsgaiA8IHBvaW50U3RyaW5ncy5sZW5ndGg7IGorKykge1xuXHRcdFx0XHRcdGNvbnN0IHBvaW50ID0gW1xuXHRcdFx0XHRcdFx0cGFyc2VGbG9hdChwb2ludFN0cmluZ3Nbal0uc3BsaXQoXCIsXCIpWzBdKSxcblx0XHRcdFx0XHRcdHBhcnNlRmxvYXQocG9pbnRTdHJpbmdzW2pdLnNwbGl0KFwiLFwiKVsxXSksXG5cdFx0XHRcdFx0XTtcblx0XHRcdFx0XHRpZiAocG9pbnRHcm91cHNbaSAtIDFdID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdHBvaW50R3JvdXBzW2kgLSAxXSA9IFtdO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdHBvaW50R3JvdXBzW2kgLSAxXVtwb2ludEdyb3Vwc1tpIC0gMV0ubGVuZ3RoXSA9IHBvaW50O1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdGFsZXJ0KFwibm90IGZvdW5kIE1cIik7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHBvaW50R3JvdXBzLmxlbmd0aCA+IDAgPyBwb2ludEdyb3VwcyA6IG51bGw7XG5cdH1cblxuXHRwcm90ZWN0ZWQgc3RhdGljIGNvdW50T2NjdXJyZW5jZXModGV4dDogc3RyaW5nLCBzZWFyY2g6IHN0cmluZyk6IG51bWJlciB7XG5cdFx0cmV0dXJuIHRleHQuc3BsaXQoc2VhcmNoKS5sZW5ndGggLSAxO1xuXHR9XG5cblx0cHJvdGVjdGVkIHN0YXRpYyBnZXRSYW5nZU9mKHRleHQ6IHN0cmluZywgc2VhcmNoOiBzdHJpbmcsIG5vOiBudW1iZXIpOiBudW1iZXJbXSB8IG51bGwge1xuXHRcdGlmICh0aGlzLmNvdW50T2NjdXJyZW5jZXModGV4dCwgc2VhcmNoKSA+PSBubykge1xuXHRcdFx0bGV0IHN0YXJ0SW5kZXg6IG51bWJlciA9IDA7XG5cdFx0XHRsZXQgZW5kSW5kZXg6IG51bWJlciA9IDA7XG5cdFx0XHRsZXQgbjogbnVtYmVyID0gMDtcblxuXHRcdFx0d2hpbGUgKG4gPCBubykge1xuXHRcdFx0XHRzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHNlYXJjaCwgc3RhcnRJbmRleCkgKyBzZWFyY2gubGVuZ3RoO1xuXHRcdFx0XHRuKys7XG5cdFx0XHR9XG5cblx0XHRcdGVuZEluZGV4ID0gKHRleHQuaW5kZXhPZihzZWFyY2gsIHN0YXJ0SW5kZXgpID09PSAtMSkgPyB0ZXh0Lmxlbmd0aCA6IHRleHQuaW5kZXhPZihzZWFyY2gsIHN0YXJ0SW5kZXgpO1xuXG5cdFx0XHRyZXR1cm4gW1xuXHRcdFx0XHRzdGFydEluZGV4LFxuXHRcdFx0XHRlbmRJbmRleFxuXHRcdFx0XTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0fVxuXHR9XG5cblx0cHJvdGVjdGVkIHN0YXRpYyBnZXRQb2ludHNEaXN0YW5jZShwb2ludDE6IG51bWJlcltdLCBwb2ludDI6IG51bWJlcltdKTogbnVtYmVyIHtcblx0XHRyZXR1cm4gTWF0aC5zcXJ0KE1hdGgucG93KHBvaW50MlswXSAtIHBvaW50MVswXSwgMikgKyBNYXRoLnBvdyhwb2ludDJbMV0gLSBwb2ludDFbMV0sIDIpKTtcblx0fVxuXG5cdHByb3RlY3RlZCBzdGF0aWMgZ2V0TGluZUxlbmd0aChwb2ludEdyb3VwOiBudW1iZXJbXVtdKTogbnVtYmVyIHtcblx0XHRsZXQgbGVuZ3RoOiBudW1iZXIgPSAwLjA7XG5cblx0XHRmb3IgKGxldCBpID0gMTsgaSA8IHBvaW50R3JvdXAubGVuZ3RoOyBpKyspIHtcblx0XHRcdGxlbmd0aCArPSB0aGlzLmdldFBvaW50c0Rpc3RhbmNlKHBvaW50R3JvdXBbaSAtIDFdLCBwb2ludEdyb3VwW2ldKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gbGVuZ3RoO1xuXHR9XG5cblx0cHJvdGVjdGVkIHN0YXRpYyByb3VuZFBvaW50KHBvaW50OiBudW1iZXJbXSk6IG51bWJlcltdIHtcblx0XHRwb2ludFswXSA9IE1hdGgucm91bmQoKHBvaW50WzBdICsgTnVtYmVyLkVQU0lMT04pICogMTAwMCkgLyAxMDAwO1xuXHRcdHBvaW50WzFdID0gTWF0aC5yb3VuZCgocG9pbnRbMV0gKyBOdW1iZXIuRVBTSUxPTikgKiAxMDAwKSAvIDEwMDA7XG5cblx0XHRyZXR1cm4gcG9pbnQ7XG5cdH1cblxuXHRwcm90ZWN0ZWQgc3RhdGljIGNoYW5nZVBvaW50R3JvdXBBdExlbmd0aChwb2ludEdyb3VwOiBudW1iZXJbXVtdLCBsZW5ndGg6IG51bWJlcik6IG51bWJlcltdW10ge1xuXHRcdGxldCBjdXJyZW50TGVuZ3RoOiBudW1iZXIgPSAwO1xuXHRcdGNvbnN0IG5ld1BvaW50R3JvdXA6IG51bWJlcltdW10gPSBbcG9pbnRHcm91cFswXV07XG5cblx0XHRmb3IgKGxldCBpID0gMTsgaSA8IHBvaW50R3JvdXAubGVuZ3RoOyBpKyspIHtcblx0XHRcdGNvbnN0IGN1cnJlbnRMaW5lTGVuZ3RoID0gdGhpcy5nZXRQb2ludHNEaXN0YW5jZShwb2ludEdyb3VwW2kgLSAxXSwgcG9pbnRHcm91cFtpXSk7XG5cdFx0XHRjdXJyZW50TGVuZ3RoICs9IGN1cnJlbnRMaW5lTGVuZ3RoO1xuXHRcdFx0bmV3UG9pbnRHcm91cC5wdXNoKHBvaW50R3JvdXBbaV0pO1xuXG5cdFx0XHRpZiAoY3VycmVudExlbmd0aCA+PSBsZW5ndGgpIHtcblx0XHRcdFx0Y29uc3QgbmV3TGluZUxlbmd0aCA9IGxlbmd0aCArIGN1cnJlbnRMaW5lTGVuZ3RoIC0gY3VycmVudExlbmd0aDtcblx0XHRcdFx0Y29uc3QgYmV0d2Vlbkxlbmd0aFJhdGlvID0gbmV3TGluZUxlbmd0aCAvIGN1cnJlbnRMaW5lTGVuZ3RoO1xuXG5cdFx0XHRcdG5ld1BvaW50R3JvdXBbaV0gPSB0aGlzLnJvdW5kUG9pbnQoW1xuXHRcdFx0XHRcdHBvaW50R3JvdXBbaSAtIDFdWzBdICsgKChwb2ludEdyb3VwW2ldWzBdIC0gcG9pbnRHcm91cFtpIC0gMV1bMF0pICogYmV0d2Vlbkxlbmd0aFJhdGlvKSxcblx0XHRcdFx0XHRwb2ludEdyb3VwW2kgLSAxXVsxXSArICgocG9pbnRHcm91cFtpXVsxXSAtIHBvaW50R3JvdXBbaSAtIDFdWzFdKSAqIGJldHdlZW5MZW5ndGhSYXRpbylcblx0XHRcdFx0XSk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBuZXdQb2ludEdyb3VwO1xuXHR9XG5cblx0cHJvdGVjdGVkIHN0YXRpYyBnZXRQb2ludEdyb3VwU3RyaW5nTWlzc2luZyhwb2ludEdyb3VwU3RyaW5nOiBzdHJpbmcsIHBvaW50R3JvdXBObzogbnVtYmVyKTogc3RyaW5nIHtcblx0XHRjb25zdCBwb2ludEdyb3VwTnVtOiBudW1iZXIgPSB0aGlzLmNvdW50T2NjdXJyZW5jZXMocG9pbnRHcm91cFN0cmluZywgJ00nKTtcblx0XHRsZXQgcG9pbnRHcm91cE1pc3NpbmdOdW06IG51bWJlciA9IDA7XG5cdFx0bGV0IHBvaW50R3JvdXBNaXNzaW5nU3RyaW5nOiBzdHJpbmcgPSAnJztcblxuXHRcdGlmIChwb2ludEdyb3VwTm8gLSBwb2ludEdyb3VwTnVtID4gMSkge1xuXHRcdFx0cG9pbnRHcm91cE1pc3NpbmdOdW0gPSBwb2ludEdyb3VwTm8gLSBwb2ludEdyb3VwTnVtIC0gMTtcblx0XHR9XG5cblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IHBvaW50R3JvdXBNaXNzaW5nTnVtOyBpKyspIHtcblx0XHRcdHBvaW50R3JvdXBNaXNzaW5nU3RyaW5nICs9ICdNMCwwJztcblx0XHR9XG5cblx0XHRyZXR1cm4gcG9pbnRHcm91cE1pc3NpbmdTdHJpbmc7XG5cdH1cblxuXHRwdWJsaWMgc3RhdGljIGRyYXdMaW5lVG9Wb2x1bWUocG9pbnRHcm91cDogbnVtYmVyW11bXSwgcG9pbnRHcm91cE5vOiBudW1iZXIsIGRBdHRyaWJ1dGU6IHN0cmluZywgZWxlbWVudDogSFRNTEVsZW1lbnQsIHZvbHVtZTogbnVtYmVyKTogc3RyaW5nIHtcblx0XHRpZiAodm9sdW1lID49IDAgJiYgdm9sdW1lIDw9IDEwMCkge1xuXHRcdFx0Y29uc3QgbGVuZ3RoOiBudW1iZXIgPSB0aGlzLmdldExpbmVMZW5ndGgocG9pbnRHcm91cCkgLyAxMDAgKiB2b2x1bWU7XG5cdFx0XHRjb25zdCBuZXdQb2ludEdyb3VwOiBudW1iZXJbXVtdID0gdGhpcy5jaGFuZ2VQb2ludEdyb3VwQXRMZW5ndGgocG9pbnRHcm91cCwgbGVuZ3RoKTtcblx0XHRcdGxldCB3b3JrUmFuZ2U6IG51bWJlcltdID0gdGhpcy5nZXRSYW5nZU9mKGRBdHRyaWJ1dGUsICdNJywgcG9pbnRHcm91cE5vKTtcblx0XHRcdGxldCBsaW5lU3RyaW5nOiBzdHJpbmcgPSAnJztcblxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBuZXdQb2ludEdyb3VwLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdGxpbmVTdHJpbmcgKz0gbGluZVN0cmluZyA9PSAnJyA/ICcnIDogJ0wnO1xuXHRcdFx0XHRsaW5lU3RyaW5nICs9IGAke25ld1BvaW50R3JvdXBbaV1bMF19LCR7bmV3UG9pbnRHcm91cFtpXVsxXX1gO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAod29ya1JhbmdlID09PSBudWxsKSB7XG5cdFx0XHRcdGRBdHRyaWJ1dGUgPSBgJHtkQXR0cmlidXRlfSR7dGhpcy5nZXRQb2ludEdyb3VwU3RyaW5nTWlzc2luZyhkQXR0cmlidXRlLCBwb2ludEdyb3VwTm8pfU0ke2xpbmVTdHJpbmd9YDtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdGRBdHRyaWJ1dGUgPSBkQXR0cmlidXRlLnN1YnN0cmluZygwLCB3b3JrUmFuZ2VbMF0pICsgbGluZVN0cmluZyArIGRBdHRyaWJ1dGUuc3Vic3RyaW5nKHdvcmtSYW5nZVsxXSwgZEF0dHJpYnV0ZS5sZW5ndGgpO1xuXHRcdFx0fVxuXG5cdFx0XHRlbGVtZW50LnNldEF0dHJpYnV0ZSgnZCcsIGRBdHRyaWJ1dGUpO1xuXHRcdFx0cmV0dXJuIGRBdHRyaWJ1dGU7XG5cdFx0fVxuXHR9XG59XG4iXX0=